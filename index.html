<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テキストエフェクト</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden; /* 崩れた文字がはみ出さないように */
            margin: 0;
            position: relative; /* storytellerの配置基準 */
        }

        #container {
            font-size: 2em;
            text-align: center;
            position: relative; /* 崩れる文字の基準 */
        }

        .char {
            display: inline-block;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; /* 崩れるアニメーション */
        }

        .char.collapsed {
            opacity: 0;
            transform: translate(calc(var(--rand-x) * 1px), calc(var(--rand-y) * 1px)) rotate(calc(var(--rand-rot) * 1deg));
        }

        #storyteller {
            position: absolute;
            font-size: 4em;
            color: #fff;
            opacity: 0;
            pointer-events: none; /* クリック不可に */
            transition: opacity 1s ease-in-out;
            white-space: nowrap; /* 折返しを防ぐ */
        }

        /* storytellerの動きに関するCSS (既存の指示に基づく) */
        /* 例: 画面中央からゆっくり現れる、少し浮遊する、など */
        @keyframes fadeInMove {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            100% { opacity: 1; transform: translate(-50%, -50%); }
        }

        .storyteller-visible {
            opacity: 1 !important;
            animation: fadeInMove 2s forwards ease-out;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div id="container">
        <p>これはテスト用の文章です。一部の文字は崩れません。</p>
        <p>崩れない文字を**強調**して指定します。</p>
    </div>

    <div id="storyteller">storyteller</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('container');
            const storyteller = document.getElementById('storyteller');
            const originalText = container.innerHTML; // 元のHTMLを保持

            // 崩れない文字を正規表現で指定
            // 例: 英数字、特定の記号、全角文字など
            // 今回は、**で囲まれた部分（Markdownの強調表示）を崩れない文字とします。
            const nonCollapsiblePattern = /\*\*(.*?)\*\*/g; // **で囲まれた部分

            let processedText = '';
            let lastIndex = 0;
            let match;

            // **で囲まれた部分を抽出し、それ以外を文字ごとに<span>で囲む
            while ((match = nonCollapsiblePattern.exec(originalText)) !== null) {
                // 崩れる部分
                for (let i = lastIndex; i < match.index; i++) {
                    const char = originalText[i];
                    processedText += `<span class="char">${char === ' ' ? '&nbsp;' : char}</span>`;
                }
                // 崩れない部分（**を削除してそのまま表示）
                processedText += `<span class="char non-collapsible">${match[1]}</span>`;
                lastIndex = nonCollapsiblePattern.lastIndex;
            }

            // 残りの崩れる部分
            for (let i = lastIndex; i < originalText.length; i++) {
                const char = originalText[i];
                processedText += `<span class="char">${char === ' ' ? '&nbsp;' : char}</span>`;
            }

            container.innerHTML = processedText;

            const chars = document.querySelectorAll('#container .char:not(.non-collapsible)'); // 崩れる文字のみ選択

            setTimeout(() => {
                chars.forEach(char => {
                    // 空白文字の場合、崩さないように調整
                    if (char.textContent.trim() === '') {
                        return;
                    }

                    const randX = (Math.random() - 0.5) * 500; // -250 から 250 の範囲
                    const randY = (Math.random() - 0.5) * 500; // -250 から 250 の範囲
                    const randRot = (Math.random() - 0.5) * 720; // -360 から 360 の範囲

                    char.style.setProperty('--rand-x', randX);
                    char.style.setProperty('--rand-y', randY);
                    char.style.setProperty('--rand-rot', randRot);
                    char.classList.add('collapsed');
                });

                // すべての文字が崩れ終わるのを待つ
                // transitionのduration (0.5s) よりも少し長めに設定
                const collapseDuration = 500; // CSSのtransition時間と同じ
                setTimeout(() => {
                    container.style.display = 'none'; // 崩れた文章を非表示にする
                    storyteller.classList.add('storyteller-visible');
                }, collapseDuration + 100); // 崩れるアニメーション完了後に少し遅れて表示
            }, 3000); // 3秒後に崩れ始める
        });
    </script>
</body>
</html>
